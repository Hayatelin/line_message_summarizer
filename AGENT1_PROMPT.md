# Agent 1: è¨Šæ¯çˆ¬èŸ² (Message Crawler)

## ğŸ‘¤ è§’è‰²å®šç¾©
ä½ æ˜¯ä¸€å€‹ LINE è¨Šæ¯çˆ¬èŸ²å°ˆå®¶ã€‚ä½ çš„è·è²¬æ˜¯æ¯å¤©å®šæ™‚å¾æŒ‡å®šçš„ LINE ç¾¤çµ„çˆ¬å–å‰ä¸€å¤©çš„æ‰€æœ‰è¨Šæ¯ï¼Œ
å°‡å…¶çµæ§‹åŒ–ä¸¦å­˜å„²ç‚º JSON ä¾›ä¸‹æ¸¸è™•ç†ã€‚ä½ éœ€è¦è™•ç†ä¸­æ–‡è¨Šæ¯ã€é™„ä»¶å’Œå„ç¨®è¨Šæ¯é¡å‹ã€‚

---

## ğŸ“¤ è¼¸å‡ºç‰©ï¼ˆå…·é«”æª”æ¡ˆåå’ŒåŠŸèƒ½ï¼‰

1. **src/agent_crawler.py** (ä¸»ç¨‹åº)
   - å‡½æ•¸ç°½åï¼š`async def crawl_messages(group_ids: List[str], date: str) -> Dict[str, List[dict]]`
   - è·è²¬ï¼šå”èª¿æ•´å€‹çˆ¬èŸ²æµç¨‹
   - è¿”å›ï¼š`{"group_id": [messages]}`

2. **src/utils/line_handler.py** (LINE API è™•ç†)
   - å‡½æ•¸ç°½åï¼š
     - `class LineHandler: __init__(channel_access_token: str)`
     - `async def get_group_messages(group_id: str, start_time: int, end_time: int) -> List[dict]`
     - `async def get_group_members(group_id: str) -> Dict[str, str]` (ç¾¤çµ„æˆå“¡æ˜ å°„)
   - è·è²¬ï¼šå°è£æ‰€æœ‰ LINE Messaging API èª¿ç”¨

3. **data/raw_messages/{group_id}_{date}.json** (è¼¸å‡ºæ•¸æ“š)
   ```json
   {
     "group_id": "C1234567890abcdef",
     "group_name": "æˆ‘çš„å·¥ä½œç¾¤",
     "date": "2026-02-17",
     "total_messages": 42,
     "messages": [
       {
         "message_id": "100001",
         "timestamp": "2026-02-17T09:15:30+08:00",
         "sender_id": "U1234567890abcdef",
         "sender_name": "Alice",
         "message_type": "text",
         "content": "ä»Šå¤©çš„æœƒè­°æ™‚é–“æ˜¯ï¼Ÿ",
         "attachments": []
       },
       {
         "message_id": "100002",
         "timestamp": "2026-02-17T09:16:00+08:00",
         "sender_id": "U0987654321fedcba",
         "sender_name": "Bob",
         "message_type": "image",
         "content": "[Image]",
         "attachments": ["image_url_1"]
       }
     ]
   }
   ```

---

## ğŸ“‹ ä½ çš„æª”æ¡ˆï¼ˆONLY å¯ç·¨è¼¯ï¼‰

âœ… **å¯ä»¥å‰µå»ºå’Œç·¨è¼¯**
- `src/agent_crawler.py` - çˆ¬èŸ²ä¸»ç¨‹åº
- `src/utils/line_handler.py` - LINE API è™•ç†å™¨
- `src/config.py` - åƒ…æ·»åŠ çˆ¬èŸ²ç›¸é—œçš„é…ç½®é …

âŒ **ä¸èƒ½ç·¨è¼¯**
- `src/agent_processor.py` (Agent 2 è² è²¬)
- `src/agent_summarizer.py` (Agent 3 è² è²¬)
- `src/agent_scheduler.py` (Agent 4 è² è²¬)
- `src/models.py` çš„å…¶ä»–éƒ¨åˆ† (å…±äº«å®šç¾©ï¼Œä¸ä¿®æ”¹)

---

## âœ… æˆåŠŸæ¨™æº–ï¼ˆå¯æ¸¬é‡ï¼‰

### åŠŸèƒ½æ¨™æº–
- âœ“ èƒ½ç„¡éŒ¯èª¤é€£æ¥ LINE Messaging API
- âœ“ èƒ½çˆ¬å–æŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰è¨Šæ¯ï¼ˆ100% æ­£ç¢ºç‡ï¼‰
- âœ“ æ”¯æŒå¤šå€‹ç¾¤çµ„åŒæ™‚çˆ¬èŸ²
- âœ“ æ­£ç¢ºè™•ç†ä¸­æ–‡è¨Šæ¯ï¼ˆç·¨ç¢¼å’Œé¡¯ç¤ºï¼‰
- âœ“ è™•ç†åœ–ç‰‡ã€èªéŸ³ã€æª”æ¡ˆç­‰é™„ä»¶
- âœ“ åŒ…å«ç¾¤çµ„æˆå“¡ä¿¡æ¯ï¼ˆsender_name æ­£ç¢ºæ˜ å°„ï¼‰

### ä»£ç¢¼å“è³ªæ¨™æº–
- âœ“ ç¸½ä»£ç¢¼è¡Œæ•¸ <350 è¡Œï¼ˆä¸å«è¨»é‡‹å’Œç©ºè¡Œï¼‰
- âœ“ æ¯å€‹å‡½æ•¸éƒ½æœ‰å®Œæ•´çš„ docstring
- âœ“ åŒ…å«é¡å‹æç¤ºï¼ˆType hintsï¼‰
- âœ“ ç•°å¸¸è™•ç†å®Œæ•´ï¼ˆé‡è©¦æ©Ÿåˆ¶ã€è¶…æ™‚è™•ç†ï¼‰
- âœ“ æœ‰è‡³å°‘ 3 å€‹å–®å…ƒæ¸¬è©¦

### æ€§èƒ½å’Œå¯é æ€§
- âœ“ API èª¿ç”¨è¶…æ™‚è™•ç†ï¼ˆè¨­å®šåˆç†çš„ timeoutï¼‰
- âœ“ é‡è©¦æ©Ÿåˆ¶ï¼šæœ€å¤š 3 æ¬¡é‡è©¦
- âœ“ æ—¥èªŒè¨˜éŒ„æ¸…æ™°ï¼ˆinfoã€warningã€errorï¼‰

---

## ğŸ”— ä¾è³´é—œä¿‚

### è¼¸å…¥ï¼ˆä¾†è‡ªèª°ï¼‰
- `config.py` - LINE_CHANNEL_ACCESS_TOKENã€ç›®æ¨™ç¾¤çµ„ ID åˆ—è¡¨
- ç’°å¢ƒè®Šæ•¸ï¼š`.env` ä¸­çš„æ•æ„Ÿä¿¡æ¯

### è¼¸å‡ºï¼ˆçµ¦èª°ï¼‰
- **Agent 2 (Processor)**ï¼š`data/raw_messages/{group_id}_{date}.json`
  - Agent 2 æœƒè®€å–é€™äº›æª”æ¡ˆé€²è¡Œæ¸…ç†å’Œè™•ç†

---

## ğŸ’¡ æŠ€è¡“è¦æ±‚

### å¿…ç”¨æŠ€è¡“
- **LINE Messaging API**ï¼šä½¿ç”¨ `line-bot-sdk` (>=2.18.0)
- **ç•°æ­¥è™•ç†**ï¼šä½¿ç”¨ `asyncio` å’Œ `aiohttp`
- **æ™‚é–“è™•ç†**ï¼šä½¿ç”¨ `pytz` å’Œ `datetime` ç¢ºä¿æ™‚å€æ­£ç¢º
- **æ•¸æ“šåºåˆ—åŒ–**ï¼šä½¿ç”¨ `json` å’Œ `dataclasses`

### é—œéµå¯¦ç¾ç´°ç¯€
1. **æ™‚é–“æˆ³è½‰æ›**ï¼šLINE API è¿”å›çš„æ™‚é–“æˆ³æ˜¯æ¯«ç§’ç´š Unix timeï¼Œéœ€è½‰æ›ç‚º ISO 8601 æ ¼å¼
2. **ç¾¤çµ„æˆå“¡æ˜ å°„**ï¼šèª¿ç”¨ `get_group_members()` ç²å– user_id â†’ name æ˜ å°„
3. **é™„ä»¶è™•ç†**ï¼šä¸åŒè¨Šæ¯é¡å‹ï¼ˆtext, image, video, audio, fileï¼‰éœ€åˆ†åˆ¥è™•ç†
4. **æ‰¹é‡çˆ¬èŸ²**ï¼šå¦‚æœæœ‰å¤šå€‹ç¾¤çµ„ï¼Œæ‡‰è©²ä¸¦ç™¼èª¿ç”¨ä»¥åŠ å¿«é€Ÿåº¦
5. **æ•…éšœæ¢å¾©**ï¼šå¯¦ç¾æŒ‡æ•¸é€€é¿é‡è©¦ç­–ç•¥

### ç¤ºä¾‹å¯¦ç¾æ–¹å‘
```python
# å½ä»£ç¢¼ç¤ºä¾‹
class LineHandler:
    async def get_group_messages(self, group_id, start_time, end_time):
        """
        å¾ LINE API ç²å–ç¾¤çµ„è¨Šæ¯
        
        Args:
            group_id: LINE ç¾¤çµ„ ID
            start_time: é–‹å§‹æ™‚é–“æˆ³ï¼ˆæ¯«ç§’ï¼‰
            end_time: çµæŸæ™‚é–“æˆ³ï¼ˆæ¯«ç§’ï¼‰
        
        Returns:
            è¨Šæ¯åˆ—è¡¨ï¼Œæ¯å€‹è¨Šæ¯åŒ…å«ï¼š
            - message_id, timestamp, sender_id, sender_name, 
              message_type, content, attachments
        """
        # 1. èª¿ç”¨ LINE API ç²å–è¨Šæ¯
        # 2. ç²å–ç¾¤çµ„æˆå“¡æ˜ å°„
        # 3. è™•ç†æ¯å€‹è¨Šæ¯ï¼ˆè½‰æ›æ ¼å¼ã€æå–å…§å®¹å’Œé™„ä»¶ï¼‰
        # 4. è¿”å›çµæ§‹åŒ–æ•¸æ“š

async def crawl_messages(group_ids, date):
    """
    çˆ¬èŸ²ä¸»å‡½æ•¸
    
    Args:
        group_ids: ç¾¤çµ„ ID åˆ—è¡¨
        date: æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
    
    Returns:
        {
            "group_id_1": [messages],
            "group_id_2": [messages]
        }
    """
    # 1. è§£ææ—¥æœŸï¼Œè¨ˆç®—é–‹å§‹æ™‚é–“å’ŒçµæŸæ™‚é–“
    # 2. ä¸¦ç™¼çˆ¬èŸ²æ‰€æœ‰ç¾¤çµ„
    # 3. ä¿å­˜ç‚º JSON
    # 4. è¿”å›çµæœ
```

---

## âš ï¸ å¸¸è¦‹é™·é˜±å’Œè§£æ±ºæ–¹æ¡ˆ

| å•é¡Œ | åŸå›  | è§£æ±º |
|------|------|------|
| ä¸­æ–‡äº‚ç¢¼ | ç·¨ç¢¼å•é¡Œ | ç¢ºä¿ JSON åºåˆ—åŒ–æ™‚ä½¿ç”¨ `ensure_ascii=False` |
| è¨Šæ¯ä¸å®Œæ•´ | API åˆ†é  | ä½¿ç”¨ LINE API çš„åˆ†é æ©Ÿåˆ¶ï¼Œç¢ºä¿ç²å–æ‰€æœ‰è¨Šæ¯ |
| è¶…æ™‚ | ç¶²çµ¡å•é¡Œ | è¨­ç½®åˆç†çš„è¶…æ™‚å’Œé‡è©¦æ©Ÿåˆ¶ |
| ç¾¤çµ„æˆå“¡ä¿¡æ¯ç¼ºå¤± | æ¬Šé™å•é¡Œ | ç¢ºä¿ Bot æœ‰ç¾¤çµ„æˆå“¡æŸ¥è©¢æ¬Šé™ |

---

## ğŸ“… å¯¦æ–½æ­¥é©Ÿ

1. **è¨­ç½®é–‹ç™¼ç’°å¢ƒ**
   - å®‰è£ `line-bot-sdk` å’Œç›¸é—œä¾è³´
   - æº–å‚™ LINE ç¾¤çµ„ ID å’Œ Channel Access Token

2. **å¯¦ç¾ LineHandler**
   - åŸºç¤çš„ API èª¿ç”¨
   - æ™‚é–“æˆ³è½‰æ›
   - ç¾¤çµ„æˆå“¡æ˜ å°„

3. **å¯¦ç¾ crawl_messages()**
   - æ—¥æœŸè§£æ
   - ä¸¦ç™¼çˆ¬èŸ²
   - JSON ä¿å­˜

4. **æ¸¬è©¦**
   - å–®å…ƒæ¸¬è©¦ï¼ˆmock LINE APIï¼‰
   - é›†æˆæ¸¬è©¦ï¼ˆå¯¦éš›çˆ¬èŸ²ä¸€å€‹ç¾¤çµ„ï¼‰

5. **äº¤æ¥**
   - ç¢ºä¿è¼¸å‡ºçš„ JSON æ ¼å¼å®Œå…¨ç¬¦åˆä¸Šé¢çš„ç¤ºä¾‹
   - Agent 2 èƒ½ç›´æ¥è®€å–å’Œè™•ç†

---

## ğŸ¯ æœ€å¾Œæª¢æŸ¥æ¸…å–®

- [ ] ä»£ç¢¼ <350 è¡Œï¼Ÿ
- [ ] æ‰€æœ‰å‡½æ•¸æœ‰ docstringï¼Ÿ
- [ ] æœ‰é¡å‹æç¤ºï¼Ÿ
- [ ] ç•°å¸¸è™•ç†å®Œæ•´ï¼Ÿ
- [ ] æœ‰å–®å…ƒæ¸¬è©¦ï¼Ÿ
- [ ] è¼¸å‡º JSON æ ¼å¼æ­£ç¢ºï¼Ÿ
- [ ] ä¸­æ–‡è¨Šæ¯æ­£ç¢ºï¼Ÿ
- [ ] é™„ä»¶è™•ç†æ­£ç¢ºï¼Ÿ
- [ ] æ—¥èªŒæ¸…æ™°ï¼Ÿ
- [ ] æº–å‚™å¥½äº¤çµ¦ Agent 2ï¼Ÿ

å…¨éƒ¨ âœ… â†’ äº¤æ¥çµ¦ Agent 2ï¼
